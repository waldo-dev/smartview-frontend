version: '3.8'

services:
  # Aplicación Backend Node.js
  backend:
    build:
      context: ./backend  # Ruta relativa desde donde está docker-compose.yml
      dockerfile: Dockerfile
    container_name: smartview-backend
    restart: unless-stopped
    ports:
      - "${PORT:-5000}:5000"
    environment:
      # Database - Conectarse a la base de datos en otro contenedor
      # Opción 1: Si está en otro docker-compose, usa el nombre del servicio
      # Opción 2: Si es un contenedor independiente, usa el nombre del contenedor
      # Opción 3: Si está en el host, usa host.docker.internal
      DB_HOST: ${DB_HOST:-host.docker.internal}
      DB_NAME: ${DB_NAME:-smartview_db}
      DB_USER: ${DB_USER:-smartview_db}
      DB_PASSWORD: ${DB_PASSWORD:-sm4rtv13w}
      DB_PORT: ${DB_PORT:-5432}
      
      # Server
      PORT: 5000
      NODE_ENV: ${NODE_ENV:-production}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      
      # Power BI / Azure AD
      AZURE_CLIENT_ID: ${AZURE_CLIENT_ID:-}
      AZURE_CLIENT_SECRET: ${AZURE_CLIENT_SECRET:-}
      AZURE_TENANT_ID: ${AZURE_TENANT_ID:-}
      POWERBI_WORKSPACE_ID: ${POWERBI_WORKSPACE_ID:-}
      POWERBI_SCOPE: ${POWERBI_SCOPE:-https://analysis.windows.net/powerbi/api/.default}
    networks:
      - smartview-network
    # Para Linux, necesitas esto para acceder a host.docker.internal
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Si la DB está en otro docker-compose, conecta las redes:
    # Descomenta y ajusta el nombre de la red:
    # external_networks:
    #   - nombre-de-la-red-del-otro-docker-compose
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend - React/Vite
  frontend:
    build:
      context: ./frontend  # Ruta relativa desde donde está docker-compose.yml
      dockerfile: Dockerfile
    container_name: smartview-frontend
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"  # Para HTTPS si lo configuras después
    environment:
      # La URL del backend será accesible por el nombre del servicio
      - VITE_API_URL=http://backend:5000/api
    volumes:
      # Montar configuración de nginx si necesitas modificarla
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - smartview-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  smartview-network:
    driver: bridge
  # Si la DB está en otro docker-compose, descomenta y ajusta:
  # db-network:
  #   external: true
  #   name: nombre-de-la-red-del-otro-docker-compose
